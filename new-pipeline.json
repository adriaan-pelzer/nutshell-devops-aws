{
    "Resources": {
        "AdminUser": {
            "Type": "AWS::IAM::User",
            "Properties": {
                "LoginProfile": {
                    "Password": "root",
                    "PasswordResetRequired": true
                },
                "Path": "/",
                "Policies": [ 
                    {
                        "PolicyName": "new-pipeline-admin-user",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Sid": "AllowAll",
                                    "Action": [
                                        "*"
                                    ],
                                    "Resource": "*",
                                    "Effect": "Allow"
                                },
                                {
                                    "Sid": "EnforceMFADisabledChangeEffectToDenyToEnable",
                                    "Effect": "Allow",
                                    "Action": [
                                        "*"
                                    ],
                                    "Resource": "*",
                                    "Condition": { "BoolIfExists": { "aws:MultiFactorAuthPresent": false } }
                                }
                            ]
                        }
                    }
                ],
                "UserName": "root"
            }
        },
        "CloudformationTemplateBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": "new-pipeline-cloudformation-template-bucket"
            }
        },
        "Repository": {
            "Type": "AWS::CodeCommit::Repository",
            "Properties": {
                "RepositoryDescription": "A repository that triggers a codebuild project that creates a new code pipeline",
                "RepositoryName": "new-pipeline",
                "Triggers": [
                    {
                        "Name": "new-pipeline-trigger",
                        "DestinationArn": { "Fn::GetAtt": [ "LambdaTrigger", "Arn" ] },
                        "Events": [ "all" ]
                    }
                ]
            }
        },
        "LambdaTriggerInvokePermission": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "Action": "lambda:InvokeFunction",
                "Principal": "codecommit.amazonaws.com",
                "FunctionName": { "Fn::GetAtt": [ "LambdaTrigger", "Arn" ] }
            }
        },
        "LambdaTriggerRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "new-pipeline-lambda-role",
                "AssumeRolePolicyDocument": {
                    "Version" : "2012-10-17",
                    "Statement": [ {
                        "Effect": "Allow",
                        "Principal": {
                            "Service": [ "lambda.amazonaws.com" ]
                        },
                        "Action": [ "sts:AssumeRole" ]
                    } ]
                },
                "Path": "/",
                "Policies": [
                    {
                        "PolicyName": "new-pipeline-lambda-policy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": "arn:aws:logs:*:*:*",
                                    "Effect": "Allow"
                                },
                                {
                                    "Action": [
                                        "codebuild:StartBuild"
                                    ],
                                    "Resource": { "Fn::Join": [ ":", [
                                        "arn:aws:codebuild",
                                        { "Ref": "AWS::Region" },
                                        { "Ref": "AWS::AccountId" },
                                        "project/new-pipeline-codebuild-project"
                                    ] ] },
                                    "Effect": "Allow"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "LambdaTrigger": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Code": {
                    {
                        "Records": [
                            {
                                "awsRegion": "eu-west-1",
                                "codecommit": {
                                    "references": [
                                        {
                                            "commit": "b25d117941af07f0e38b26350188ddf39b056847",
                                            "ref": "refs/heads/master"
                                        }
                                    ]
                                },
                                "eventId": "5027a7ae-b122-4d20-abab-ae47f494cfd4",
                                "eventName": "ReferenceChanges",
                                "eventPartNumber": 1,
                                "eventSource": "aws:codecommit",
                                "eventSourceARN": "arn:aws:codecommit:eu-west-1:296024228272:new-pipeline",
                                "eventTime": "2018-11-07T13:20:09.740+0000",
                                "eventTotalParts": 1,
                                "eventTriggerConfigId": "0608536e-ae7d-4605-9a00-414ae1e2d555",
                                "eventTriggerName": "new-pipeline-trigger",
                                "eventVersion": "1.0",
                                "userIdentityARN": "arn:aws:iam::296024228272:user/adriaan.pelzer"
                            }
                        ]
                    },
                    {
                        "Records": [
                            {
                                "awsRegion": "eu-west-1",
                                "codecommit": {
                                    "references": [
                                        {
                                            "commit": "b25d117941af07f0e38b26350188ddf39b056847",
                                            "created": true,
                                            "ref": "refs/tags/test-tag-hallo"
                                        }
                                    ]
                                },
                                "eventId": "a248cd5c-6896-4e0a-b568-54d0a32e1e8a",
                                "eventName": "ReferenceChanges",
                                "eventPartNumber": 1,
                                "eventSource": "aws:codecommit",
                                "eventSourceARN": "arn:aws:codecommit:eu-west-1:296024228272:new-pipeline",
                                "eventTime": "2018-11-07T13:24:40.244+0000",
                                "eventTotalParts": 1,
                                "eventTriggerConfigId": "0608536e-ae7d-4605-9a00-414ae1e2d555",
                                "eventTriggerName": "new-pipeline-trigger",
                                "eventVersion": "1.0",
                                "userIdentityARN": "arn:aws:iam::296024228272:user/adriaan.pelzer"
                            }
                        ]
                    },
                    "ZipFile": { "Fn::Join": [ "\n", [
                        "module.exports.handler = ( event, context, callback ) => {",
                        "    const tags = ( event.Records || [] ).find (",
                        "        Record => ( ( Record.codecommit || {} ).references || [] ).find (",
                        "            reference => reference.ref.match ( '/tags/' )",
                        "        )",
                        "    ).map (",
                        "        reference => reference.ref.split ( '/' ) ).map (",
                        "            ( [ refs, tags, tag ] ) => tag ).map (",
                        "                tag => tag.split ( '-' )",
                        "            ).map (",
                        "                ( [ Platform, Service, StackType ] ) => ( { Platform, Service, StackType } )",
                        "            )",
                        "        )",
                        "    );",
                        "    console.log ( JSON.stringify ( tags ) );",
                        "    return callback ( null, 'DONE' );",
                        "};"
                    ] ] }
                },
                "FunctionName": "new-pipeline-lambda",
                "Handler": "index.handler",
                "MemorySize": "128",
                "Timeout": "30",
                "Role": { "Fn::GetAtt": [ "LambdaTriggerRole", "Arn" ] },
                "Runtime": "nodejs8.10"
            }
        },
        "CodeBuildProjectRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "new-pipeline-codebuild-project-role",
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Action": "sts:AssumeRole",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "codebuild.amazonaws.com"
                            }
                        }
                    ]
                },
                "Path": "/",
                "Policies": [
                    {
                        "PolicyName": "new-pipeline-codebuild-project-policy",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Action": [
                                        "logs:CreateLogGroup",
                                        "logs:CreateLogStream",
                                        "logs:PutLogEvents"
                                    ],
                                    "Resource": "arn:aws:logs:*:*:*",
                                    "Effect": "Allow"
                                },
                                {
                                    "Action": [
                                        "codecommit:GitPull"
                                    ],
                                    "Resource": { "Fn::GetAtt": [ "Repository", "Arn" ] },
                                    "Effect": "Allow"
                                }
                            ]
                        }
                    }
                ]
            }
        },
        "CodeBuildProject": {
            "Type": "AWS::CodeBuild::Project",
            "Properties": {
                "Name": "new-pipeline-codebuild-project",
                "Description": "A codeBuild project that creates new code pipelines",
                "Artifacts": {
                    "Type": "NO_ARTIFACTS"
                },
                "BadgeEnabled": true,
                "Environment": {
                    "EnvironmentVariables": [
                        {
                            "Name": "CFN_TEMPLATE_BUCKET",
                            "Value": { "Ref": "CloudformationTemplateBucket" }
                        }
                    ],
                    "ComputeType": "BUILD_GENERAL1_SMALL",
                    "Image": "aws/codebuild/nodejs:10.1.0",
                    "Type": "LINUX_CONTAINER",
                    "PrivilegedMode": false
                },
                "ServiceRole": { "Fn::GetAtt": [ "CodeBuildProjectRole", "Arn" ] },
                "Source": {
                    "BuildSpec": { "Fn::Join": [ "\n", [
                        "version: 0.2",
                        "",
                        "phases:",
                        "  build:",
                        "    commands:",
                        "      - /bin/bash build-pipeline.sh"
                    ] ] },
                    "Type": "CODECOMMIT",
                    "Location": { "Fn::GetAtt": [ "Repository", "CloneUrlHttp" ] }
                }
            }
        }
    }
}
